{
  "version": 3,
  "sources": ["src/app/core/services/auth.service.ts"],
  "sourcesContent": ["// ==============================================\r\n// auth.service.ts\r\n// Authentication Service\r\n// ==============================================\r\n// Responsibilities:\r\n// - Login / Logout\r\n// - Get current user\r\n// - Check authentication state\r\n// - Check permissions\r\n// - Manage auth state reactively\r\n// ==============================================\r\n\r\nimport { Injectable, computed, signal, inject } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Router } from '@angular/router';\r\nimport { Observable, tap, catchError, throwError, BehaviorSubject } from 'rxjs';\r\nimport { TokenService } from './token.service';\r\nimport {\r\n    AuthResponse,\r\n    AuthState,\r\n    CurrentUser,\r\n    LoginRequest,\r\n    RegisterRequest\r\n} from '../auth/auth.models';\r\nimport { environment } from '../../../environments/environment';\r\nimport { NotificationsService } from '../../features/notifications/services/notifications.service';\r\nimport { NotificationService } from './notification.service';\r\n\r\nconst API_URL = environment.apiUrl;\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n    // Reactive auth state using signals\r\n    private authState = signal<AuthState>({\r\n        user: null,\r\n        isAuthenticated: false,\r\n        isLoading: false,\r\n        error: null\r\n    });\r\n\r\n    // Public computed values\r\n    readonly currentUser = computed(() => this.authState().user);\r\n    readonly isAuthenticated = computed(() => this.authState().isAuthenticated);\r\n    readonly isLoading = computed(() => this.authState().isLoading);\r\n    readonly authError = computed(() => this.authState().error);\r\n\r\n    // Permissions from current user\r\n    readonly permissions = computed(() => this.authState().user?.permissions ?? []);\r\n    readonly roles = computed(() => this.authState().user?.roles ?? []);\r\n\r\n    // BehaviorSubject for components that need Observable\r\n    private isAuthenticated$ = new BehaviorSubject<boolean>(false);\r\n\r\n    // Inject NotificationsService for SignalR\r\n    private notificationsService = inject(NotificationsService);\r\n\r\n    // Toast service\r\n    private toastService = inject(NotificationService);\r\n\r\n    constructor(\r\n        private http: HttpClient,\r\n        private tokenService: TokenService,\r\n        private router: Router\r\n    ) {\r\n        // Initialize auth state from stored token\r\n        this.initializeAuthState();\r\n    }\r\n\r\n    /**\r\n     * Initialize auth state from stored token on app startup\r\n     */\r\n    private initializeAuthState(): void {\r\n        if (this.tokenService.isTokenValid()) {\r\n            const storedUser = this.tokenService.getUser<CurrentUser>();\r\n            const token = this.tokenService.getToken();\r\n            if (storedUser) {\r\n                this.updateState({\r\n                    user: storedUser,\r\n                    isAuthenticated: true,\r\n                    isLoading: false,\r\n                    error: null\r\n                });\r\n                this.isAuthenticated$.next(true);\r\n\r\n                // Start SignalR if token exists\r\n                if (token) {\r\n                    this.notificationsService.startSignalR(token);\r\n                }\r\n            } else {\r\n                // Token exists but no user data - fetch from API\r\n                this.fetchCurrentUser();\r\n            }\r\n        } else {\r\n            // Invalid or no token - clear everything\r\n            this.tokenService.clearAll();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Login with email and password\r\n     */\r\n    login(credentials: LoginRequest, rememberMe: boolean = false): Observable<AuthResponse> {\r\n        this.updateState({ ...this.authState(), isLoading: true, error: null });\r\n\r\n        return this.http.post<AuthResponse>(`${API_URL}/auth/login`, credentials).pipe(\r\n            tap(response => {\r\n                this.handleAuthSuccess(response, rememberMe);\r\n            }),\r\n            catchError(error => {\r\n                this.updateState({\r\n                    ...this.authState(),\r\n                    isLoading: false,\r\n                    error: error.error?.detail || 'LOGIN.ERROR.INVALID_CREDENTIALS'\r\n                });\r\n                return throwError(() => error);\r\n            })\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Register new user\r\n     */\r\n    register(data: RegisterRequest): Observable<AuthResponse> {\r\n        this.updateState({ ...this.authState(), isLoading: true, error: null });\r\n\r\n        return this.http.post<AuthResponse>(`${API_URL}/auth/register`, data).pipe(\r\n            tap(response => {\r\n                this.handleAuthSuccess(response, false);\r\n            }),\r\n            catchError(error => {\r\n                this.updateState({\r\n                    ...this.authState(),\r\n                    isLoading: false,\r\n                    error: error.error?.detail || 'REGISTER.ERROR.FAILED'\r\n                });\r\n                return throwError(() => error);\r\n            })\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Logout user and clear all tokens\r\n     */\r\n    logout(): void {\r\n        // Stop SignalR before clearing tokens\r\n        this.notificationsService.stopSignalR();\r\n\r\n        this.tokenService.clearAll();\r\n        this.updateState({\r\n            user: null,\r\n            isAuthenticated: false,\r\n            isLoading: false,\r\n            error: null\r\n        });\r\n        this.isAuthenticated$.next(false);\r\n\r\n        // Show logout toast\r\n        this.toastService.info('You have been logged out successfully', { title: 'ðŸ‘‹ Goodbye!' });\r\n\r\n        this.router.navigate(['/login']);\r\n    }\r\n\r\n    /**\r\n     * Fetch current user from API\r\n     */\r\n    fetchCurrentUser(): Observable<CurrentUser> {\r\n        return this.http.get<CurrentUser>(`${API_URL}/auth/me`).pipe(\r\n            tap(user => {\r\n                const currentState = this.authState();\r\n                const updatedUser: CurrentUser = {\r\n                    ...user,\r\n                    permissions: this.tokenService.getPermissions(),\r\n                    roles: this.tokenService.getRoles()\r\n                };\r\n                this.tokenService.setUser(updatedUser, !!localStorage.getItem('access_token'));\r\n                this.updateState({\r\n                    ...currentState,\r\n                    user: updatedUser,\r\n                    isAuthenticated: true,\r\n                    isLoading: false\r\n                });\r\n            }),\r\n            catchError(error => {\r\n                this.logout();\r\n                return throwError(() => error);\r\n            })\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Check if user has a specific permission\r\n     */\r\n    hasPermission(permission: string): boolean {\r\n        return this.permissions().includes(permission);\r\n    }\r\n\r\n    /**\r\n     * Check if user has any of the specified permissions\r\n     */\r\n    hasAnyPermission(permissions: string[]): boolean {\r\n        const userPermissions = this.permissions();\r\n        return permissions.some(p => userPermissions.includes(p));\r\n    }\r\n\r\n    /**\r\n     * Check if user has all specified permissions\r\n     */\r\n    hasAllPermissions(permissions: string[]): boolean {\r\n        const userPermissions = this.permissions();\r\n        return permissions.every(p => userPermissions.includes(p));\r\n    }\r\n\r\n    /**\r\n     * Check if user has a specific role\r\n     */\r\n    hasRole(role: string): boolean {\r\n        return this.roles().includes(role);\r\n    }\r\n\r\n    /**\r\n     * Check if user is admin\r\n     */\r\n    isAdmin(): boolean {\r\n        return this.hasRole('Admin');\r\n    }\r\n\r\n    /**\r\n     * Get authentication observable for guards\r\n     */\r\n    getAuthState(): Observable<boolean> {\r\n        return this.isAuthenticated$.asObservable();\r\n    }\r\n\r\n    /**\r\n     * Handle successful authentication\r\n     */\r\n    private handleAuthSuccess(response: AuthResponse, rememberMe: boolean): void {\r\n        // Store token\r\n        this.tokenService.setToken(response.accessToken, rememberMe);\r\n\r\n        // Create current user from response\r\n        const user: CurrentUser = {\r\n            id: response.userId,\r\n            email: response.email,\r\n            firstName: response.fullName.split(' ')[0] || '',\r\n            lastName: response.fullName.split(' ').slice(1).join(' ') || '',\r\n            fullName: response.fullName,\r\n            roles: response.roles,\r\n            permissions: response.permissions,\r\n            createdAt: new Date(),\r\n            lastLoginAt: new Date()\r\n        };\r\n\r\n        // Store user\r\n        this.tokenService.setUser(user, rememberMe);\r\n\r\n        // Update state\r\n        this.updateState({\r\n            user,\r\n            isAuthenticated: true,\r\n            isLoading: false,\r\n            error: null\r\n        });\r\n\r\n        this.isAuthenticated$.next(true);\r\n\r\n        // Start SignalR for real-time notifications\r\n        this.notificationsService.startSignalR(response.accessToken);\r\n\r\n        // Show welcome toast\r\n        this.toastService.success(`Welcome back, ${user.firstName || user.fullName}!`, { title: 'ðŸ‘‹ Hello!' });\r\n    }\r\n\r\n    /**\r\n     * Update auth state\r\n     */\r\n    private updateState(state: AuthState): void {\r\n        this.authState.set(state);\r\n    }\r\n\r\n    /**\r\n     * Clear error state\r\n     */\r\n    clearError(): void {\r\n        this.updateState({\r\n            ...this.authState(),\r\n            error: null\r\n        });\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
