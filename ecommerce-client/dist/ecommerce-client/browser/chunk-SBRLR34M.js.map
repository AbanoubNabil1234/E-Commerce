{
  "version": 3,
  "sources": ["src/app/core/services/language.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject, Observable, firstValueFrom } from 'rxjs';\r\nimport { TranslateService } from '@ngx-translate/core';\r\n\r\nexport type SupportedLanguage = 'en' | 'ar';\r\n\r\nexport interface LanguageConfig {\r\n    code: SupportedLanguage;\r\n    name: string;\r\n    nativeName: string;\r\n    dir: 'ltr' | 'rtl';\r\n}\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n})\r\nexport class LanguageService {\r\n    private readonly STORAGE_KEY = 'app_language';\r\n    private readonly DEFAULT_LANGUAGE: SupportedLanguage = 'en';\r\n\r\n    readonly supportedLanguages: LanguageConfig[] = [\r\n        { code: 'en', name: 'English', nativeName: 'English', dir: 'ltr' },\r\n        { code: 'ar', name: 'Arabic', nativeName: 'العربية', dir: 'rtl' }\r\n    ];\r\n\r\n    private currentLanguageSubject: BehaviorSubject<SupportedLanguage>;\r\n    currentLanguage$: Observable<SupportedLanguage>;\r\n    private initialized = false;\r\n\r\n    constructor(private translate: TranslateService) {\r\n        const savedLanguage = this.getSavedLanguage();\r\n        this.currentLanguageSubject = new BehaviorSubject<SupportedLanguage>(savedLanguage);\r\n        this.currentLanguage$ = this.currentLanguageSubject.asObservable();\r\n    }\r\n\r\n    /**\r\n     * Initialize translations - MUST be called via APP_INITIALIZER\r\n     * Returns a Promise that resolves when translations are fully loaded\r\n     */\r\n    async initializeLanguage(): Promise<void> {\r\n        if (this.initialized) return;\r\n\r\n        // Configure available languages\r\n        this.translate.addLangs(['en', 'ar']);\r\n        this.translate.setDefaultLang(this.DEFAULT_LANGUAGE);\r\n\r\n        const savedLanguage = this.getSavedLanguage();\r\n\r\n        // Wait for translations to load completely\r\n        await firstValueFrom(this.translate.use(savedLanguage));\r\n\r\n        // Apply DOM settings after translations are loaded\r\n        this.applyDomSettings(savedLanguage);\r\n\r\n        this.initialized = true;\r\n        console.log(`[LanguageService] Initialized with language: ${savedLanguage}`);\r\n    }\r\n\r\n    /**\r\n     * Get the current language code\r\n     */\r\n    get currentLanguage(): SupportedLanguage {\r\n        return this.currentLanguageSubject.value;\r\n    }\r\n\r\n    /**\r\n     * Get the current language configuration\r\n     */\r\n    get currentLanguageConfig(): LanguageConfig {\r\n        return this.supportedLanguages.find(l => l.code === this.currentLanguage)\r\n            ?? this.supportedLanguages[0];\r\n    }\r\n\r\n    /**\r\n     * Check if current language is RTL\r\n     */\r\n    get isRTL(): boolean {\r\n        return this.currentLanguageConfig.dir === 'rtl';\r\n    }\r\n\r\n    /**\r\n     * Switch to a different language\r\n     * CRITICAL: Update currentLanguageSubject BEFORE translate.use() to ensure\r\n     * the LanguageInterceptor sends correct Accept-Language header when \r\n     * onLangChange handlers make HTTP requests.\r\n     */\r\n    async setLanguage(languageCode: SupportedLanguage): Promise<void> {\r\n        if (this.currentLanguage === languageCode) return;\r\n\r\n        if (!this.isSupported(languageCode)) {\r\n            console.warn(`Language '${languageCode}' is not supported. Falling back to default.`);\r\n            languageCode = this.DEFAULT_LANGUAGE;\r\n        }\r\n\r\n        // CRITICAL FIX: Update the Subject FIRST so interceptor has correct value\r\n        // when onLangChange handlers fire HTTP requests\r\n        this.currentLanguageSubject.next(languageCode);\r\n        this.saveLanguage(languageCode);\r\n        this.applyDomSettings(languageCode);\r\n\r\n        // Now load translations (onLangChange will fire AFTER Subject is updated)\r\n        await firstValueFrom(this.translate.use(languageCode));\r\n    }\r\n\r\n    /**\r\n     * Toggle between EN and AR\r\n     */\r\n    toggleLanguage(): void {\r\n        const newLang = this.currentLanguage === 'en' ? 'ar' : 'en';\r\n        this.setLanguage(newLang);\r\n    }\r\n\r\n    /**\r\n     * Check if a language code is supported\r\n     */\r\n    isSupported(languageCode: string): languageCode is SupportedLanguage {\r\n        return this.supportedLanguages.some(l => l.code === languageCode);\r\n    }\r\n\r\n    /**\r\n     * Apply language settings to the DOM (dir, lang attributes)\r\n     */\r\n    private applyDomSettings(languageCode: SupportedLanguage): void {\r\n        const config = this.supportedLanguages.find(l => l.code === languageCode);\r\n        if (!config) return;\r\n\r\n        // Update HTML attributes\r\n        document.documentElement.lang = languageCode;\r\n        document.documentElement.dir = config.dir;\r\n\r\n        // Add/remove RTL class for Tailwind\r\n        if (config.dir === 'rtl') {\r\n            document.documentElement.classList.add('rtl');\r\n            document.documentElement.classList.remove('ltr');\r\n        } else {\r\n            document.documentElement.classList.add('ltr');\r\n            document.documentElement.classList.remove('rtl');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get saved language from localStorage\r\n     */\r\n    private getSavedLanguage(): SupportedLanguage {\r\n        try {\r\n            const saved = localStorage.getItem(this.STORAGE_KEY);\r\n            if (saved && this.isSupported(saved)) {\r\n                return saved;\r\n            }\r\n        } catch {\r\n            // localStorage not available\r\n        }\r\n\r\n        // Try browser language\r\n        const browserLang = navigator.language.split('-')[0];\r\n        if (this.isSupported(browserLang)) {\r\n            return browserLang;\r\n        }\r\n\r\n        return this.DEFAULT_LANGUAGE;\r\n    }\r\n\r\n    /**\r\n     * Save language preference to localStorage\r\n     */\r\n    private saveLanguage(languageCode: SupportedLanguage): void {\r\n        try {\r\n            localStorage.setItem(this.STORAGE_KEY, languageCode);\r\n        } catch {\r\n            // localStorage not available\r\n        }\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;AAgBM,IAAO,kBAAP,MAAO,iBAAe;EAaJ;EAZH,cAAc;EACd,mBAAsC;EAE9C,qBAAuC;IAC5C,EAAE,MAAM,MAAM,MAAM,WAAW,YAAY,WAAW,KAAK,MAAK;IAChE,EAAE,MAAM,MAAM,MAAM,UAAU,YAAY,8CAAW,KAAK,MAAK;;EAG3D;EACR;EACQ,cAAc;EAEtB,YAAoB,WAA2B;AAA3B,SAAA,YAAA;AAChB,UAAM,gBAAgB,KAAK,iBAAgB;AAC3C,SAAK,yBAAyB,IAAI,gBAAmC,aAAa;AAClF,SAAK,mBAAmB,KAAK,uBAAuB,aAAY;EACpE;;;;;EAMM,qBAAkB;;AACpB,UAAI,KAAK;AAAa;AAGtB,WAAK,UAAU,SAAS,CAAC,MAAM,IAAI,CAAC;AACpC,WAAK,UAAU,eAAe,KAAK,gBAAgB;AAEnD,YAAM,gBAAgB,KAAK,iBAAgB;AAG3C,YAAM,eAAe,KAAK,UAAU,IAAI,aAAa,CAAC;AAGtD,WAAK,iBAAiB,aAAa;AAEnC,WAAK,cAAc;AACnB,cAAQ,IAAI,gDAAgD,aAAa,EAAE;IAC/E;;;;;EAKA,IAAI,kBAAe;AACf,WAAO,KAAK,uBAAuB;EACvC;;;;EAKA,IAAI,wBAAqB;AACrB,WAAO,KAAK,mBAAmB,KAAK,OAAK,EAAE,SAAS,KAAK,eAAe,KACjE,KAAK,mBAAmB,CAAC;EACpC;;;;EAKA,IAAI,QAAK;AACL,WAAO,KAAK,sBAAsB,QAAQ;EAC9C;;;;;;;EAQM,YAAY,cAA+B;;AAC7C,UAAI,KAAK,oBAAoB;AAAc;AAE3C,UAAI,CAAC,KAAK,YAAY,YAAY,GAAG;AACjC,gBAAQ,KAAK,aAAa,YAAY,8CAA8C;AACpF,uBAAe,KAAK;MACxB;AAIA,WAAK,uBAAuB,KAAK,YAAY;AAC7C,WAAK,aAAa,YAAY;AAC9B,WAAK,iBAAiB,YAAY;AAGlC,YAAM,eAAe,KAAK,UAAU,IAAI,YAAY,CAAC;IACzD;;;;;EAKA,iBAAc;AACV,UAAM,UAAU,KAAK,oBAAoB,OAAO,OAAO;AACvD,SAAK,YAAY,OAAO;EAC5B;;;;EAKA,YAAY,cAAoB;AAC5B,WAAO,KAAK,mBAAmB,KAAK,OAAK,EAAE,SAAS,YAAY;EACpE;;;;EAKQ,iBAAiB,cAA+B;AACpD,UAAM,SAAS,KAAK,mBAAmB,KAAK,OAAK,EAAE,SAAS,YAAY;AACxE,QAAI,CAAC;AAAQ;AAGb,aAAS,gBAAgB,OAAO;AAChC,aAAS,gBAAgB,MAAM,OAAO;AAGtC,QAAI,OAAO,QAAQ,OAAO;AACtB,eAAS,gBAAgB,UAAU,IAAI,KAAK;AAC5C,eAAS,gBAAgB,UAAU,OAAO,KAAK;IACnD,OAAO;AACH,eAAS,gBAAgB,UAAU,IAAI,KAAK;AAC5C,eAAS,gBAAgB,UAAU,OAAO,KAAK;IACnD;EACJ;;;;EAKQ,mBAAgB;AACpB,QAAI;AACA,YAAM,QAAQ,aAAa,QAAQ,KAAK,WAAW;AACnD,UAAI,SAAS,KAAK,YAAY,KAAK,GAAG;AAClC,eAAO;MACX;IACJ,QAAQ;IAER;AAGA,UAAM,cAAc,UAAU,SAAS,MAAM,GAAG,EAAE,CAAC;AACnD,QAAI,KAAK,YAAY,WAAW,GAAG;AAC/B,aAAO;IACX;AAEA,WAAO,KAAK;EAChB;;;;EAKQ,aAAa,cAA+B;AAChD,QAAI;AACA,mBAAa,QAAQ,KAAK,aAAa,YAAY;IACvD,QAAQ;IAER;EACJ;;qCA3JS,kBAAe,mBAAA,gBAAA,CAAA;EAAA;4EAAf,kBAAe,SAAf,iBAAe,WAAA,YAFZ,OAAM,CAAA;;",
  "names": []
}
