{
  "version": 3,
  "sources": ["src/app/core/services/token.service.ts"],
  "sourcesContent": ["// ==============================================\r\n// token.service.ts\r\n// JWT Token Management Service\r\n// ==============================================\r\n// Responsibilities:\r\n// - Store/retrieve tokens securely\r\n// - Decode JWT payload\r\n// - Check token expiration\r\n// - Clear tokens on logout\r\n// ==============================================\r\n\r\nimport { Injectable } from '@angular/core';\r\nimport { JwtPayload } from '../auth/auth.models';\r\n\r\nconst TOKEN_KEY = 'access_token';\r\nconst USER_KEY = 'current_user';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n})\r\nexport class TokenService {\r\n\r\n    /**\r\n     * Store the access token\r\n     * Using sessionStorage for better security (clears on tab close)\r\n     * Use localStorage if \"remember me\" is checked\r\n     */\r\n    setToken(token: string, rememberMe: boolean = false): void {\r\n        const storage = rememberMe ? localStorage : sessionStorage;\r\n        storage.setItem(TOKEN_KEY, token);\r\n    }\r\n\r\n    /**\r\n     * Get the stored access token\r\n     */\r\n    getToken(): string | null {\r\n        return sessionStorage.getItem(TOKEN_KEY) || localStorage.getItem(TOKEN_KEY);\r\n    }\r\n\r\n    /**\r\n     * Remove the stored token\r\n     */\r\n    removeToken(): void {\r\n        sessionStorage.removeItem(TOKEN_KEY);\r\n        localStorage.removeItem(TOKEN_KEY);\r\n    }\r\n\r\n    /**\r\n     * Store user data in memory/storage\r\n     */\r\n    setUser(user: any, rememberMe: boolean = false): void {\r\n        const storage = rememberMe ? localStorage : sessionStorage;\r\n        storage.setItem(USER_KEY, JSON.stringify(user));\r\n    }\r\n\r\n    /**\r\n     * Get stored user data\r\n     */\r\n    getUser<T>(): T | null {\r\n        const userData = sessionStorage.getItem(USER_KEY) || localStorage.getItem(USER_KEY);\r\n        if (userData) {\r\n            try {\r\n                return JSON.parse(userData) as T;\r\n            } catch {\r\n                return null;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Remove stored user data\r\n     */\r\n    removeUser(): void {\r\n        sessionStorage.removeItem(USER_KEY);\r\n        localStorage.removeItem(USER_KEY);\r\n    }\r\n\r\n    /**\r\n     * Clear all auth data\r\n     */\r\n    clearAll(): void {\r\n        this.removeToken();\r\n        this.removeUser();\r\n    }\r\n\r\n    /**\r\n     * Decode JWT token without external library\r\n     */\r\n    decodeToken(): JwtPayload | null {\r\n        const token = this.getToken();\r\n        if (!token) {\r\n            return null;\r\n        }\r\n\r\n        try {\r\n            // JWT structure: header.payload.signature\r\n            const parts = token.split('.');\r\n            if (parts.length !== 3) {\r\n                return null;\r\n            }\r\n\r\n            // Decode the payload (second part)\r\n            const payload = parts[1];\r\n            // Handle base64url encoding\r\n            const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');\r\n            const jsonPayload = decodeURIComponent(\r\n                atob(base64)\r\n                    .split('')\r\n                    .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\r\n                    .join('')\r\n            );\r\n\r\n            return JSON.parse(jsonPayload) as JwtPayload;\r\n        } catch (error) {\r\n            console.error('Error decoding token:', error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if token exists and is not expired\r\n     */\r\n    isTokenValid(): boolean {\r\n        const token = this.getToken();\r\n        if (!token) {\r\n            return false;\r\n        }\r\n\r\n        const decoded = this.decodeToken();\r\n        if (!decoded) {\r\n            return false;\r\n        }\r\n\r\n        // Check expiration (exp is in seconds, Date.now() is in milliseconds)\r\n        const expirationTime = decoded.exp * 1000;\r\n        const now = Date.now();\r\n\r\n        // Add 30 seconds buffer to handle clock skew\r\n        return expirationTime > (now + 30000);\r\n    }\r\n\r\n    /**\r\n     * Get time until token expires (in milliseconds)\r\n     */\r\n    getTokenExpirationTime(): number | null {\r\n        const decoded = this.decodeToken();\r\n        if (!decoded) {\r\n            return null;\r\n        }\r\n\r\n        const expirationTime = decoded.exp * 1000;\r\n        return expirationTime - Date.now();\r\n    }\r\n\r\n    /**\r\n     * Extract roles from token\r\n     */\r\n    getRoles(): string[] {\r\n        const decoded = this.decodeToken();\r\n        if (!decoded) {\r\n            return [];\r\n        }\r\n\r\n        const roles = decoded.role;\r\n        if (Array.isArray(roles)) {\r\n            return roles;\r\n        }\r\n        return roles ? [roles] : [];\r\n    }\r\n\r\n    /**\r\n     * Extract permissions from token\r\n     */\r\n    getPermissions(): string[] {\r\n        const decoded = this.decodeToken();\r\n        if (!decoded) {\r\n            return [];\r\n        }\r\n\r\n        const permissions = decoded.permission;\r\n        if (Array.isArray(permissions)) {\r\n            return permissions;\r\n        }\r\n        return permissions ? [permissions] : [];\r\n    }\r\n\r\n    /**\r\n     * Check if user has a specific permission\r\n     */\r\n    hasPermission(permission: string): boolean {\r\n        return this.getPermissions().includes(permission);\r\n    }\r\n\r\n    /**\r\n     * Check if user has any of the specified permissions\r\n     */\r\n    hasAnyPermission(permissions: string[]): boolean {\r\n        const userPermissions = this.getPermissions();\r\n        return permissions.some(p => userPermissions.includes(p));\r\n    }\r\n\r\n    /**\r\n     * Check if user has all specified permissions\r\n     */\r\n    hasAllPermissions(permissions: string[]): boolean {\r\n        const userPermissions = this.getPermissions();\r\n        return permissions.every(p => userPermissions.includes(p));\r\n    }\r\n\r\n    /**\r\n     * Check if user has a specific role\r\n     */\r\n    hasRole(role: string): boolean {\r\n        return this.getRoles().includes(role);\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
